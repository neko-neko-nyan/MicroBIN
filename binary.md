# Файл / пакет MicroBIN

Файл (пакет) состоит из заголовка и следующих за ним одного или нескольких объектов.
Эти объекты называются глобальными.

## Структура заголовка файла (пакета) MicroBIN.

| Байт    |  0  |  1  |  2  -  3  |  4  |  5  |  6  -  7  |
| ------- | --- | --- | --------- | --- | --- | --------- |
|Значение |`'m'`|`'b'`| `MAG`     |`VER`|`FLG`|`CNT`      |

1. `'m'`, `'b'` - "магическое" число MicroBIN.
2. `MAG` - "магическое" число, определяемое форматом (приложением).
3. `VER` - версия формата MicroBIN, должно быть равно 0.
4. `FLG` - флаги файла (пакета), описаны ниже.
5. `CNT` - количество глобальных объектов, не должно быть равно 0.

## Флаги файла (пакета) MicroBIN

| Бит  | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 |
| ---- | - | - | - | - | - | - | - | - |
| Флаг | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |

1. `0` - не используется, должен быть равен 0.
 
## Объект MicroBIN

Объект состоит из заголовка объекта и необязательных данных.
В заголовке содержится тип объекта и числовое поле переменной длины VAR, использование которого зависит от типа объекта.
Наличие, длина и тип данных объекта также зависят от его типа.

### Первый байт заголовка объекта 

| Бит      | 0 - 2 | 3 - 7 |
| -------- |-------|-------|
| Описание | `TYPE`|`HIVAR`|

1. `TYPE` - 3 бита - тип объекта.
2. `HIVAR` - 5 бит - старшая часть данных переменной длины поля VAR.

#### TYPE

| 0 | 1 | 2 | Тип     |
|---|---|---|---------|
| 0 | 0 | 0 | SPECIAL |
| 0 | 0 | 1 | RATIONAL|
| 0 | 1 | 0 | INT     |
| 0 | 1 | 1 | NINT    |
| 1 | 0 | 0 | STRING  |
| 1 | 0 | 1 | BYTES   |
| 1 | 1 | 0 | LIST    |
| 1 | 1 | 1 | MAP     |

1. SPECIAL - один из вспомогательных типов, в зависимости от VAR:
  1) 0 - NONE
  2) 1 - BOOLEAN - false
  3) 2 - BOOLEAN - true
  4) 3 - FLOAT16 - число с плавающей запятой половинной точности IEEE754
  5) 4 - FLOAT32 - число с плавающей запятой одинарной точности IEEE754
  6) 5 - FLOAT64 - число с плавающей запятой двойной точности IEEE754
  7) 6 - 15 - зарезервировано.
  8) 16 - ... - неверное использование
2. RATIONAL - рациональное число.
3. INT - положительное целое число, value = VAR.
4. NINT - отрицательное целое число, value = -VAR.
5. STRING - строка utf-8, байтовая длина = VAR.
6. BYTES - байтовая строка, длина = VAR.
7. LIST - список элементов, количество = VAR.
8. MAP - ассоциативный массив, количество элементов (пар ключ-значение) = VAR.

#### HIVAR

Количество установленных бит слева определяет количество байтов, в которых хранится значение VAR.

| Бит | 3 | 4 | 5 | 6 | 7 | BIT | TOTAL |
|-----|---|---|---|---|---|-----|-------|
|     | 0 | X | X | X | X |  0  |   4   |
|     | 1 | 0 | X | X | X |  1  |  11   |
|     | 1 | 1 | 0 | X | X |  2  |  18   |
|     | 1 | 1 | 1 | 0 | X |  3  |  25   |
|     | 1 | 1 | 1 | 1 | 0 |  4  |  32   |
|     | 1 | 1 | 1 | 1 | 1 |  8  |  64   |

После байта заголовка идут BIT дополнительных байт числа VAR. Дополнительные байты храняться в прямом (MSB) порядке.
Всего число VAR занимает TOTAL бит.

### Данные

Для объектов типов NONE, BOOLEAN, INT, NINT данные не предусмотрены.

Для объектов типов FLOAT16, FLOAT32 и FLOAT64 данные содержат
2, 4 или 8 байт соответственно.

Для объектов типов STRING и BYTES длина данных указана в поле VAR.

Для объектов типа LIST в поле VAR указано количество объектов.

#### MAP

В поле VAR указано количество пар объектов. Элементы объекта записываются попарно, сначал ключ, затем значение.
Один ассоциативный массив не может содержать 2 одинаковых ключа. Ключами могут является объекты типов INT, NINT, STRING, BYTES, BOOLEAN, NONE.
